---
- name: Configure sysctl for IPv4 forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    sysctl_file: "{{ sysctl_path }}"
    sysctl_set: true
    reload: true

- name: Configure sysctl for IPv6 forwarding
  ansible.posix.sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    state: present
    sysctl_file: "{{ sysctl_path }}"
    sysctl_set: true
    reload: true

- name: Add Tailscale GPG key
  ansible.builtin.apt_key:
    url: https://pkgs.tailscale.com/stable/debian/{{ ansible_distribution_release }}.noarmor.gpg
    keyring: "{{ keyring_path }}"
    state: present
  when: ansible_os_family == "Debian"

- name: Add Tailscale repository
  ansible.builtin.template:
    src: repo.sources.j2
    dest: /etc/apt/sources.list.d/tailscale.sources
    owner: root
    group: root
    mode: "0644"
  when: ansible_os_family == "Debian"

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes
  when: ansible_os_family == "Debian"

- name: Add Tailscale repository
  ansible.builtin.shell: dnf config-manager --add-repo {{ repo_uri }}/rhel/{{ ansible_distribution_major_version }}/tailscale.repo
  when: ansible_os_family == "RedHat"

- name: Install Tailscale
  ansible.builtin.package:
    name: tailscale
    state: present
