# Nomad running zitadel

```hcl
module "zitadel" {
  source                  = "registry.narwhl.workers.dev/stack/zitadel/nomad"
  datacenter_name         = local.datacenter_name
  external_domain         = "${local.zitadel_subdomain}.${local.root_domain}"
  postgres_host           = "{{ with service `postgres-rw` }}{{ with index . 0 }}{{ .Address }}{{ end }}{{ end }}"
  postgres_port           = "{{ with service `postgres-rw` }}{{ with index . 0 }}{{ .Port }}{{ end }}{{ end }}"
  postgres_database       = "zitadel"
  postgres_username       = "zitadel"
  postgres_password       = random_password.postgres_zitadel_password.result
  postgres_ssl_mode       = "disable"
  postgres_admin_username = "postgres"
  postgres_admin_password = random_password.postgres_superuser_password.result
  organization_name       = "My Organization"
  root_username           = "root"
  root_password           = "{{ with nomadVar `nomad/jobs/zitadel` }}{{ .root_password }}{{ end }}"
  masterkey               = "{{ with nomadVar `nomad/jobs/zitadel` }}{{ .masterkey }}{{ end }}"
}
```
## Future work

### Initialization Process

Currently, a root human user is created for the organization with specified
credentials. This credential, however, cannot be used for accessing the admin
API.

`zitadel` docker image provides a way to create a service (machine) user on
startup. The credential is generated by the service and stored as a file in
the container, configured by `ZITADEL_FIRSTINSTANCE_MACHINEKEYPATH` variable.
To extract this credential, we need an extra nomad task that access a shared
directory (e.g. `/alloc`) and upload it to a secret storage (e.g. Vault).

## Argument Reference

- `datacenter_name`: `(string: <required>)` - The name of the Nomad datacenter to use.

- `namespace`: `(string: <optional>)` - The namespace to run the job in. Defaults to `default`.

- `job_name`: `(string: <optional>)` - The name of the job. Defaults to `zitadel`.

- `zitadel_version`: `(string: <optional>)` - The version of Zitadel to run. Defaults to `latest`.

- `external_domain`: `(string: <required>)` - The external domain to access Zitadel.

- `traefik_entrypoints`: `(object: <optional>)` - The entrypoints to expose the service.

- `organization_name`: `(string: <optional>)` - The name of the organization. Defaults to `Zitadel`.

- `root_username`: `(string: <optional>)` - The username of the root user. Defaults to "root".

- `root_password`: `(string: <optional>)` - The password of the root user. Defaults to a random password

- `masterkey`: `(string: <optional>)` - The masterkey is used to AES256-encrypt other generated encryption keys in Zitadel. It must be 32 character length string. Defaults to a random password

- `resources`: `(object: <optional>)` - The resources to allocate to the job.

- `purge_on_destroy`: `(bool: <optional>)` - Whether to purge the job on destroy. Defaults to `false`.

## Outputs

- `root_password`: `string` - The password of the root user.

- `masterkey`: `string` - The masterkey of zitadel.
