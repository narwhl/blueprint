# Nomad running zitadel

```hcl
module "zitadel" {
  source                  = "registry.narwhl.workers.dev/stack/zitadel/nomad"
  datacenter_name         = local.datacenter_name
  external_domain         = "${local.zitadel_subdomain}.${local.root_domain}"
  postgres_host           = "{{ with service `postgres-rw` }}{{ with index . 0 }}{{ .Address }}{{ end }}{{ end }}"
  postgres_port           = "{{ with service `postgres-rw` }}{{ with index . 0 }}{{ .Port }}{{ end }}{{ end }}"
  postgres_database       = "zitadel"
  postgres_username       = "zitadel"
  postgres_password       = random_password.postgres_zitadel_password.result
  postgres_ssl_mode       = "disable"
  postgres_admin_username = "postgres"
  postgres_admin_password = random_password.postgres_superuser_password.result
  organization_name       = "My Organization"
  root_username           = "root"
  root_password           = "{{ with nomadVar `nomad/jobs/zitadel` }}{{ .root_password }}{{ end }}"
  masterkey               = "{{ with nomadVar `nomad/jobs/zitadel` }}{{ .masterkey }}{{ end }}"
}
```
## Future work

### Initialization Process

Currently, a root human user is created for the organization with specified
credentials. This credential, however, cannot be used for accessing the admin
API.

`zitadel` docker image provides a way to create a service (machine) user on
startup. The credential is generated by the service and stored as a file in
the container, configured by `ZITADEL_FIRSTINSTANCE_MACHINEKEYPATH` variable.
To extract this credential, we need an extra nomad task that access a shared
directory (e.g. `/alloc`) and upload it to a secret storage (e.g. Vault).
